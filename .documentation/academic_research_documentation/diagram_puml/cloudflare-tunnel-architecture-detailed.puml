@startuml
title Cloudflare Tunnel Architecture - Detailed Flow

skinparam backgroundColor white
skinparam padding 5
skinparam nodesep 50
skinparam ranksep 70

' End Users
actor "End Users" as users #FFE0B2
rectangle "Browsers" as browsers #FFF9C4 {
  note right
    gymms.domain
    HTTPS + TLS 1.3
  end note
}

' Cloudflare Edge
cloud "Cloudflare Edge Network" as cloudflare #BBDEFB {
  rectangle "DDoS Shield" as ddos #90CAF9
  rectangle "WAF Rules" as waf #90CAF9
  rectangle "CDN Cache" as cdn #90CAF9
  rectangle "SSL/TLS\nTermination" as ssl #90CAF9
}

' Raspberry Pi - Local Network
rectangle "Local Network 192.168.x.x" as localnet #C8E6C9 {
  note top of localnet
    No Port Forward
    No Static IP
    No Inbound Rules
  end note
  
  rectangle "Raspberry Pi 5" as rpi #A5D6A7 {
    rectangle "cloudflared\ndaemon" as tunnel #FFCC80
    rectangle "Nginx\nReverse Proxy" as nginx #81C784
    rectangle "Django App\nGunicorn" as django #66BB6A
    database "PostgreSQL\nDatabase" as db #4CAF50
  }
}

' Connections - User to Cloudflare
users --> browsers
browsers -down-> cloudflare : HTTPS Request

' Cloudflare components
ddos -[hidden]right- waf
waf -[hidden]right- cdn
cdn -[hidden]right- ssl

' Cloudflare to Raspberry Pi - Outbound tunnel
cloudflare <-down-> tunnel : "Outbound HTTPS\n(cloudflared daemon)\nPersistent Tunnel"
note on link
  Proxied HTTPS Requests
  Through Tunnel
end note

' Internal connections on Raspberry Pi
tunnel -down-> nginx : Port :80
nginx -down-> django : Port :8000
django -down-> db : PostgreSQL\nConnection

@enduml
